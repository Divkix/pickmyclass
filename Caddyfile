# Caddyfile - Reverse proxy configuration for PickMyClass
# Usage: caddy run --config Caddyfile --envfile .env
# Domain configured via environment variable, defaults to localhost for development
#
# Production: DOMAIN=pickmyclass.example.com caddy run --config Caddyfile
# Development: caddy run --config Caddyfile (uses localhost)

{$DOMAIN:localhost} {
	# Reverse proxy to Next.js application
	reverse_proxy localhost:3000 {
		# Health checks for the backend
		health_uri /api/monitoring/health
		health_interval 30s
		health_timeout 10s

		# Pass real client IP (Caddy handles X-Forwarded-* automatically)
		header_up X-Real-IP {remote_host}
	}

	# Enable compression (gzip and zstd)
	encode gzip zstd

	# Access logging with rotation
	# Note: Ensure /var/log/caddy exists and is writable by caddy user
	# Or use: output file ./logs/caddy-access.log for local development
	log {
		output file /var/log/caddy/access.log {
			roll_size 50mb
			roll_keep 5
			roll_keep_for 168h
		}
		format json
	}

	# Security headers
	header {
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# XSS protection
		X-Content-Type-Options "nosniff"
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server identification
		-Server
	}
}
