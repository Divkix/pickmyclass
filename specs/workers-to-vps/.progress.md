# Progress: workers-to-vps

## Goal
We need to move off cloudflare workers locked architecture as we are moving to our free tier oracle server

## Status
Phase 1 in progress - POC

## Completed Tasks
- [x] 1.1 Set up Redis client module - 2780309
- [x] 1.2 Implement circuit breaker with Redis - 559893c
- [x] 1.3 Implement cron lock with Redis - fec39d8
- [x] 1.4 Set up BullMQ queue infrastructure - 697308b
- [x] 1.5 Implement queue worker - 17cac30

## Current Task
Awaiting next task

## Next
Task 1.6: Implement node-cron scheduler

## Timeline
- Started: 2026-01-15
- Artifacts generated: 2026-01-15

## Learnings

### Codebase Exploration (Quick Mode)
- Current architecture heavily uses Cloudflare-specific primitives that need replacement
- `worker.ts` contains Durable Object implementations (~750 lines) for CircuitBreakerDO and CronLockDO
- Queue processing logic is split between `app/api/cron/route.ts` (enqueue) and `app/api/queue/process-section/route.ts` (process)
- Health endpoint at `app/api/monitoring/health/route.ts` checks Durable Object status
- Existing scraper service already runs on Oracle Cloud with Puppeteer
- Email sending via Resend batch API is independent of Cloudflare
- Supabase database queries are platform-agnostic

### Key Patterns Discovered
- Atomic notification deduplication via `tryRecordNotification()` PostgreSQL function
- Circuit breaker with 10 failure threshold, 2-minute recovery timeout, 3 success threshold
- Cron lock with 25-minute auto-expiry
- Staggered checking (even/odd section numbers at :00/:30)

### Cron Lock Implementation
- Used Redis SET NX PX for atomic lock acquisition with TTL baked in
- Lua script for atomic conditional release (prevents releasing locks we don't hold)
- Separate metadata key stores lockAcquiredAt timestamp for status queries
- Both lock key and metadata key share the same TTL for consistent expiry

### Architecture Decisions Made
- **BullMQ over pg-boss**: Better performance, feature parity with Cloudflare Queues
- **Upstash Redis over VPS Redis**: Free tier sufficient, no memory impact on 1GB VPS
- **PM2 over Docker**: Lower memory overhead for constrained VPS
- **Caddy over Nginx**: Automatic HTTPS, simpler configuration

### Scope Decisions
- Scraper service unchanged (already on Oracle Cloud)
- Database unchanged (Supabase PostgreSQL)
- Email service unchanged (Resend)
- Only infrastructure layer being migrated

### Assumptions Made
- Oracle Cloud VPS has 1GB RAM, 1 OCPU (ARM64)
- Upstash Redis free tier (10K commands/day) sufficient for 10K users
- DNS switch approach acceptable for zero-downtime migration
- Current 100 concurrent workers can be reduced to 4 on VPS with acceptable latency

### BullMQ Integration Notes
- BullMQ bundles its own ioredis (v5.9.1), cannot share ioredis instance from lib/redis/client.ts due to TypeScript type conflicts
- Must parse REDIS_URL and pass connection options to BullMQ Queue/Worker instead
- BullMQ requires `maxRetriesPerRequest: null` for proper blocking operations
- Queue singletons use lazy initialization to avoid connection on import
- Job deduplication via jobId: `${term}-${classNbr}` prevents duplicate processing
